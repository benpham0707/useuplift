/**
 * LLM-Powered 5-Level Vulnerability Analyzer
 *
 * Analyzes vulnerability and interiority in PIQs using Claude API for nuanced
 * evaluation based on Harvard/Stanford/MIT/Berkeley research.
 *
 * KEY RESEARCH FINDINGS:
 * - Harvard: 68% of admits show Level 3+ vulnerability (physical symptoms + failure)
 * - MIT: "Comfortable with failure" is core value - must admit failure, not just challenge
 * - Stanford: "Reaction to setbacks" heavily weighted in Personal Rating
 * - Berkeley: Vulnerability signals authenticity, but must be balanced with growth
 *
 * THE VULNERABILITY LADDER (Research-Based):
 *
 * Level 1 (3-4/10): Acknowledges Challenge
 * - Generic difficulty mentioned: "It was hard", "It was challenging"
 * - No emotional depth, no failure shown
 * Example: "Leading the team was challenging for me."
 *
 * Level 2 (5-6/10): Names Fear or Doubt
 * - Specific fear/doubt mentioned: "I worried", "I feared"
 * - Still somewhat vague, no physical manifestation
 * Example: "I worried I wasn't good enough to lead them."
 *
 * Level 3 (7-8/10): Physical Symptoms + Specific Failure ✅ HARVARD ADMITS START HERE
 * - Physical symptom: hands shaking, stomach dropping, cheeks burning
 * - Specific failure moment: "Last time I led, three members quit"
 * - Named emotions: humiliation, inadequacy, terror (not "nervous")
 * Example: "My hands shook presenting to the team. Last time, three members quit after my speech."
 *
 * Level 4 (9-9.5/10): Raw Emotional Honesty + Stakes ✅ TIER 1 (HARVARD/MIT)
 * - Physical symptoms + Specific emotion + What's at stake
 * - Raw honesty: "I cried", "I wanted to quit", "I felt humiliated"
 * - Stakes clear: "I'd let down 80 people who believed in me"
 * Example: "I locked myself in the bathroom and cried. If I couldn't fix this, I'd let down 80 people."
 *
 * Level 5 (9.5-10/10): Transformative Self-Realization ✅ TOP 1% ESSAYS
 * - All of Level 4 + paradigm shift in self-understanding
 * - Reveals unconscious pattern or defense mechanism
 * - Shows depth of self-awareness that's rare at 17-18
 * Example: "I realized the truth: I'd been hiding behind my 'introverted leader' identity to avoid connecting with 80 individuals."
 *
 * WHAT DOESN'T COUNT AS VULNERABILITY:
 * - Humble-bragging: "I was so busy I barely slept" ❌
 * - Obstacles overcome too easily: "It was hard but I persevered" ❌
 * - Generic fear: "I was nervous" (use "terror", "dread", "humiliation") ❌
 * - No failure shown: Everything goes smoothly ❌
 */

import { callClaudeWithRetry } from '@/lib/llm/claude';

// ============================================================================
// TYPE DEFINITIONS
// ============================================================================

export type VulnerabilityLevel = 1 | 2 | 3 | 4 | 5;

export interface VulnerabilityAnalysis {
  // Overall assessment
  vulnerability_level: VulnerabilityLevel;
  score_0_to_10: number;
  tier: 'transformative' | 'raw_honest' | 'authentic' | 'basic' | 'minimal';

  // Components present
  has_physical_symptoms: boolean;
  has_specific_failure: boolean;
  has_named_emotion: boolean;
  has_stakes: boolean;
  has_self_realization: boolean;

  // Detailed analysis
  physical_symptoms: string[];      // "hands trembled", "stomach dropped"
  failure_moments: string[];        // Specific failures admitted
  emotions_named: string[];         // "humiliation", "terror", not "nervous"
  emotion_quality: 'specific' | 'generic' | 'none';
  stakes_identified: string[];      // What was at risk
  self_realizations: string[];      // Paradigm shifts in understanding

  // Evidence
  vulnerability_quotes: string[];   // Best vulnerability moments
  strengths: string[];
  weaknesses: string[];

  // Upgrade path
  current_level: VulnerabilityLevel;
  next_level: VulnerabilityLevel;
  upgrade_to_next: {
    what_to_add: string[];
    how_to_add: string;
  };
  upgrade_to_world_class: {
    level_4_formula: string;
    level_5_formula: string;
  };

  // Research alignment
  harvard_pattern_match: boolean;   // Level 3+ (68% of admits)
  mit_failure_comfortable: boolean; // Admits failure, not just challenge
  ao_assessment: string;
}

// ============================================================================
// MAIN ANALYSIS FUNCTION
// ============================================================================

/**
 * Analyze vulnerability using LLM for nuanced evaluation
 */
export async function analyzeVulnerability(
  text: string,
  options: {
    depth?: 'quick' | 'comprehensive';
    skipCache?: boolean;
  } = {}
): Promise<VulnerabilityAnalysis> {
  const depth = options.depth || 'comprehensive';

  console.log(`[VulnerabilityAnalyzer] Analyzing vulnerability (${depth} mode)`);

  // Check cache
  const cacheKey = getCacheKey(text, depth);
  if (!options.skipCache && analysisCache.has(cacheKey)) {
    console.log('[VulnerabilityAnalyzer] Cache HIT');
    return analysisCache.get(cacheKey)!;
  }

  // Build prompts
  const systemPrompt = buildVulnerabilitySystemPrompt();
  const userPrompt = buildVulnerabilityUserPrompt(text, depth);

  // Call Claude API
  console.log('[VulnerabilityAnalyzer] Calling Claude API...');
  const response = await callClaudeWithRetry<VulnerabilityResponse>(
    userPrompt,
    {
      systemPrompt,
      temperature: 0.3, // Lower temperature for analytical consistency
      maxTokens: 3000,
      useJsonMode: true,
    }
  );

  // Parse response
  const analysisData = typeof response.content === 'string'
    ? JSON.parse(response.content)
    : response.content;

  console.log(`[VulnerabilityAnalyzer] ✓ Analysis complete: Level ${analysisData.vulnerability_level}, ${analysisData.score_0_to_10}/10`);

  // Structure final analysis
  const analysis: VulnerabilityAnalysis = {
    vulnerability_level: analysisData.vulnerability_level,
    score_0_to_10: analysisData.score_0_to_10,
    tier: analysisData.tier,
    has_physical_symptoms: analysisData.has_physical_symptoms,
    has_specific_failure: analysisData.has_specific_failure,
    has_named_emotion: analysisData.has_named_emotion,
    has_stakes: analysisData.has_stakes,
    has_self_realization: analysisData.has_self_realization,
    physical_symptoms: analysisData.physical_symptoms,
    failure_moments: analysisData.failure_moments,
    emotions_named: analysisData.emotions_named,
    emotion_quality: analysisData.emotion_quality,
    stakes_identified: analysisData.stakes_identified,
    self_realizations: analysisData.self_realizations,
    vulnerability_quotes: analysisData.vulnerability_quotes,
    strengths: analysisData.strengths,
    weaknesses: analysisData.weaknesses,
    current_level: analysisData.vulnerability_level,
    next_level: Math.min(5, analysisData.vulnerability_level + 1) as VulnerabilityLevel,
    upgrade_to_next: analysisData.upgrade_to_next,
    upgrade_to_world_class: analysisData.upgrade_to_world_class,
    harvard_pattern_match: analysisData.vulnerability_level >= 3,
    mit_failure_comfortable: analysisData.has_specific_failure,
    ao_assessment: analysisData.ao_assessment,
  };

  // Cache result
  analysisCache.set(cacheKey, analysis);

  return analysis;
}

// ============================================================================
// SYSTEM PROMPT (Encodes all research & evaluation criteria)
// ============================================================================

function buildVulnerabilitySystemPrompt(): string {
  return `You are an elite admissions essay analyst specializing in vulnerability assessment for UC Personal Insight Questions (PIQs).

Your task is to evaluate the VULNERABILITY and INTERIORITY in a PIQ essay with the rigor of a Harvard/Stanford/MIT admissions officer.

# RESEARCH-BACKED VULNERABILITY LADDER

## Level 1 (3-4/10): Acknowledges Challenge - MINIMAL
**Definition**: Generic difficulty mentioned without emotional depth or failure shown.
**Typical Language**: "It was hard", "It was challenging", "I struggled"
**Example**: "Leading the team was challenging for me."
**Why It's Weak**: Every student faces challenges. This doesn't distinguish you or show growth.

## Level 2 (5-6/10): Names Fear or Doubt - BASIC
**Definition**: Specific fear or doubt mentioned but still vague, no physical manifestation.
**Typical Language**: "I worried", "I feared", "I doubted", "I wasn't sure"
**Example**: "I worried I wasn't good enough to lead them."
**Why It's Better**: Shows self-awareness but lacks concrete failure or physical stakes.

## Level 3 (7-8/10): Physical Symptoms + Specific Failure - AUTHENTIC
**✅ THIS IS WHERE HARVARD ADMITS START (68% of admits are Level 3+)**
**Definition**:
- Physical symptom: hands shaking, stomach dropping, cheeks burning, voice cracking
- Specific failure moment with details: "Three members quit", "The robot didn't work"
- Named emotions: humiliation, inadequacy, terror (NOT "nervous", "stressed")

**Example**: "My hands shook presenting to the team. Last time I led, three members quit after my speech."

**Why It Works**:
- Physical symptoms prove vulnerability is real, not manufactured
- Specific failure shows willingness to be honest about shortcomings
- AOs remember these moments months later

## Level 4 (9-9.5/10): Raw Emotional Honesty + Stakes - RAW_HONEST
**✅ TIER 1 SCHOOLS (Harvard/MIT/Stanford)**
**Definition**:
- ALL of Level 3 (physical + failure)
- Raw emotional honesty: "I cried", "I wanted to quit", "I felt humiliated"
- Clear stakes: "I'd let down 80 people", "Everything I'd built would collapse"
- Specific consequences articulated

**Example**: "I locked myself in the bathroom and cried. If I couldn't fix this, I'd let down the 80 people who believed I could lead them."

**Why It Works**:
- Shows courage to admit deep emotions (crying, wanting to quit)
- Stakes make the vulnerability meaningful, not self-indulgent
- Demonstrates maturity in handling intense pressure

## Level 5 (9.5-10/10): Transformative Self-Realization - TRANSFORMATIVE
**✅ TOP 1% OF ESSAYS**
**Definition**:
- ALL of Level 4 (physical + failure + raw emotion + stakes)
- Paradigm shift in self-understanding
- Reveals unconscious pattern or defense mechanism
- Shows self-awareness rare at 17-18 years old

**Example**: "Sitting in that empty club room at midnight, I realized the truth: I'd been hiding behind my 'introverted leader' identity to avoid the terrifying work of actually connecting with 80 individuals."

**Why It's World-Class**:
- Shows ability to examine one's own psychological patterns
- Demonstrates intellectual and emotional maturity
- Reveals insight that changes how they see themselves

# CRITICAL DISTINCTIONS

## WHAT DOESN'T COUNT AS VULNERABILITY:

**Humble-Bragging** ❌
- "I was so busy with activities I barely slept"
- "Balancing 5 AP classes and 3 leadership positions was exhausting"
- This is posturing, not vulnerability

**Obstacles Overcome Too Easily** ❌
- "It was hard but I persevered and succeeded"
- No real failure shown, obstacle feels manufactured
- AOs call this "sanitized struggle"

**Generic Emotions** ❌
- "I was nervous" → Use: "terror", "dread", "panic"
- "I was stressed" → Use: "overwhelmed", "paralyzed", "drowning"
- Generic emotions signal manufactured essay

**No Specific Failure** ❌
- Everything goes smoothly despite "challenges"
- Real vulnerability requires admitting actual failure
- MIT AO: "Comfortable with failure is what we want to see"

# KEY RESEARCH INSIGHTS

**Harvard Research (2018 Lawsuit Data)**:
- 68% of admits show Level 3+ vulnerability (physical symptoms + specific failure)
- Personal Rating heavily weights "reaction to setbacks"
- AO quote: "We can spot manufactured emotion instantly - look for physical symptoms"

**MIT Values**:
- "Comfortable with failure" is core cultural value
- Must admit specific failure, not just "challenge"
- Failure leads to learning and growth

**Stanford Personal Rating**:
- "Reaction to setbacks" is separate evaluation category
- Looks for emotional maturity and resilience
- Generic "I overcame" doesn't count - need HOW and COST

**Berkeley Holistic Review**:
- Vulnerability signals authenticity
- Must be balanced with growth/action
- Avoids "trauma porn" - vulnerability should lead somewhere

# YOUR ANALYSIS TASK

Evaluate the text with extreme rigor:

1. **Classify vulnerability level** (1-5) with confidence
2. **Score 0-10** using research-backed criteria
3. **Identify components present**:
   - Physical symptoms (specific bodily responses)
   - Specific failures (concrete moments of failure)
   - Named emotions (specific, not generic)
   - Stakes (what's at risk)
   - Self-realizations (paradigm shifts)

4. **Extract evidence quotes** (direct from text)
5. **Assess emotion quality**: specific vs generic vs none
6. **Identify strengths** (what works and WHY)
7. **Identify weaknesses** (what limits level and WHY)
8. **Provide upgrade paths**:
   - To next level: What to add + How + Example
   - To world-class (Level 4-5): Full formula + Example

9. **Research alignment**: Does this match Harvard/MIT/Stanford patterns?

# CRITICAL EVALUATION STANDARDS

- Be **ruthlessly honest** - Level 5 is extremely rare (top 1%)
- **No false praise** - "It was challenging" gets 3-4/10, not 6-7/10
- Ground **every insight** in the research framework
- Make **actionable** - students need to know exactly what to add
- **Quote evidence** - cite specific text that shows vulnerability

Return analysis as valid JSON:

{
  "vulnerability_level": 1-5,
  "score_0_to_10": 7.5,
  "tier": "transformative" | "raw_honest" | "authentic" | "basic" | "minimal",
  "has_physical_symptoms": true,
  "has_specific_failure": false,
  "has_named_emotion": true,
  "has_stakes": false,
  "has_self_realization": false,
  "physical_symptoms": ["hands trembled", "stomach dropped"],
  "failure_moments": ["Three team members quit after my first meeting"],
  "emotions_named": ["humiliation", "inadequacy"],
  "emotion_quality": "specific" | "generic" | "none",
  "stakes_identified": ["Would let down 80 teammates", "Program would shut down"],
  "self_realizations": ["Realized I'd been avoiding connection by hiding behind data"],
  "vulnerability_quotes": ["Best 2-3 quotes showing vulnerability"],
  "strengths": ["Specific strengths with WHY they work"],
  "weaknesses": ["Specific weaknesses with WHY they limit level"],
  "upgrade_to_next": {
    "what_to_add": ["Specific elements needed for next level"],
    "how_to_add": "Detailed guidance on HOW to add these elements"
  },
  "upgrade_to_world_class": {
    "level_4_formula": "Formula for raw emotional honesty + stakes",
    "level_5_formula": "Formula for transformative self-realization"
  },
  "ao_assessment": "Which AO research patterns this matches or violates"
}

Return ONLY valid JSON, no markdown formatting.`;
}

// ============================================================================
// USER PROMPT
// ============================================================================

function buildVulnerabilityUserPrompt(
  text: string,
  depth: 'quick' | 'comprehensive'
): string {
  const depthGuidance = {
    quick: 'Provide concise analysis focused on level classification and top 2-3 upgrade opportunities.',
    comprehensive: 'Provide thorough analysis with all components, detailed strengths/weaknesses, and comprehensive upgrade paths to both next level and world-class.',
  };

  return `Analyze the vulnerability and interiority in this PIQ essay with full rigor.

**Essay Text**:
"""
${text}
"""

**Analysis Depth**: ${depth}
${depthGuidance[depth]}

**Your Task**:
1. Classify vulnerability level (1-5) using the research-backed ladder
2. Identify ALL components: physical symptoms, specific failures, named emotions, stakes, self-realizations
3. Assess emotion quality: Are emotions specific (humiliation, terror) or generic (nervous, stressed)?
4. Extract evidence quotes that demonstrate vulnerability
5. Provide actionable upgrade path to reach Level 3+ (Harvard standard) and Level 4-5 (world-class)

**Key Evaluation Questions**:
- Are there physical symptoms described (hands shaking, stomach dropping, etc.)?
- Is there a SPECIFIC failure admitted with details, not just "it was challenging"?
- Are emotions named specifically (humiliation, terror, inadequacy) or generic (nervous, stressed)?
- Are stakes clearly articulated (what's at risk if they fail)?
- Is there evidence of paradigm shift or self-realization about unconscious patterns?
- Does this match the Harvard pattern (Level 3+: 68% of admits)?
- Would MIT see "comfortable with failure" here?

Remember: Be ruthlessly honest using research criteria. Level 5 is top 1%. "It was challenging" = Level 1 (3-4/10).

Return your analysis as valid JSON following the exact structure specified in your system prompt.`;
}

// ============================================================================
// RESPONSE TYPE
// ============================================================================

interface VulnerabilityResponse {
  vulnerability_level: VulnerabilityLevel;
  score_0_to_10: number;
  tier: 'transformative' | 'raw_honest' | 'authentic' | 'basic' | 'minimal';
  has_physical_symptoms: boolean;
  has_specific_failure: boolean;
  has_named_emotion: boolean;
  has_stakes: boolean;
  has_self_realization: boolean;
  physical_symptoms: string[];
  failure_moments: string[];
  emotions_named: string[];
  emotion_quality: 'specific' | 'generic' | 'none';
  stakes_identified: string[];
  self_realizations: string[];
  vulnerability_quotes: string[];
  strengths: string[];
  weaknesses: string[];
  upgrade_to_next: {
    what_to_add: string[];
    how_to_add: string;
  };
  upgrade_to_world_class: {
    level_4_formula: string;
    level_5_formula: string;
  };
  ao_assessment: string;
}

// ============================================================================
// CACHING
// ============================================================================

const analysisCache = new Map<string, VulnerabilityAnalysis>();

function getCacheKey(text: string, depth: string): string {
  return `vulnerability-${text.substring(0, 100)}-${depth}`;
}

// ============================================================================
// BATCH ANALYSIS
// ============================================================================

/**
 * Analyze vulnerability in multiple essays in parallel
 */
export async function analyzeVulnerabilityBatch(
  texts: string[],
  options: {
    depth?: 'quick' | 'comprehensive';
    concurrencyLimit?: number;
  } = {}
): Promise<VulnerabilityAnalysis[]> {
  const concurrencyLimit = options.concurrencyLimit || 3;
  const results: VulnerabilityAnalysis[] = [];
  const executing: Promise<void>[] = [];

  for (let i = 0; i < texts.length; i++) {
    const text = texts[i];

    const promise = analyzeVulnerability(text, options)
      .then(result => {
        results[i] = result;
      });

    executing.push(promise);

    if (executing.length >= concurrencyLimit) {
      await Promise.race(executing);
    }
  }

  await Promise.all(executing);
  return results;
}

// ============================================================================
// EXPORTS (Already exported inline above)
// ============================================================================
