/**
 * WORLD-CLASS VULNERABILITY ANALYZER V3 (Simplified, Reliable, WITH STORYTELLING)
 *
 * V3 Changes:
 * - Simplified JSON structure for 100% reliability
 * - Clear, unambiguous field names
 * - Explicit examples in system prompt
 * - Focus on DEEP ANALYSIS, simple structure
 * - Principles over templates (not biased to specific memoirs)
 * - Storytelling/mentor layer (feels authentic, caring, understanding)
 */
import { callClaudeWithRetry } from '../../../lib/llm/claude';
// ============================================================================
// MAIN ANALYSIS FUNCTION
// ============================================================================
export async function analyzeVulnerability(fullEssay, options = {}) {
    const depth = options.depth || 'comprehensive';
    const essayType = options.essayType || 'leadership';
    console.log(`[VulnerabilityAnalyzer V3] Analyzing with memoir-level depth (${depth} mode)`);
    // Check cache
    const cacheKey = `vuln-v3-${fullEssay.substring(0, 100)}-${depth}`;
    if (!options.skipCache && analysisCache.has(cacheKey)) {
        console.log('[VulnerabilityAnalyzer V3] Cache HIT');
        return analysisCache.get(cacheKey);
    }
    // Build prompts
    const systemPrompt = buildSystemPrompt();
    const userPrompt = buildUserPrompt(fullEssay, essayType, depth);
    // Call Claude API
    console.log('[VulnerabilityAnalyzer V3] Calling Claude API...');
    try {
        const response = await callClaudeWithRetry(userPrompt, {
            systemPrompt,
            temperature: 0.3,
            maxTokens: 12000,
            useJsonMode: true,
        });
        // Parse response
        const analysis = typeof response.content === 'string'
            ? JSON.parse(response.content)
            : response.content;
        console.log(`[VulnerabilityAnalyzer V3] ✓ Complete: Level ${analysis.vulnerability_level} (${analysis.vulnerability_score}/10)`);
        // Cache result
        analysisCache.set(cacheKey, analysis);
        return analysis;
    }
    catch (parseError) {
        // If JSON parsing fails (likely due to truncation), return a minimal fallback analysis
        console.warn(`[VulnerabilityAnalyzer V3] ⚠ JSON parse failed, using fallback analysis: ${parseError.message}`);
        const fallbackAnalysis = {
            vulnerability_score: 2.0,
            vulnerability_level: 1,
            tier_label: "minimal",
            defense_mechanisms: ["Unable to analyze - essay too short or generic"],
            unconscious_patterns: [],
            self_awareness_quality: "Unable to assess due to limited vulnerability",
            authenticity_score: 2.0,
            authentic_markers: [],
            manufactured_red_flags: ["Generic language", "No specific emotional details"],
            emotional_specificity: "Minimal emotional specificity detected",
            vulnerability_revelation_method: "Stated rather than shown",
            opening_vulnerability: 2,
            peak_vulnerability: 2,
            peak_moment_quote: "No specific vulnerable moment identified",
            closing_vulnerability: 2,
            arc_pattern: "flat",
            arc_quality: "No vulnerability arc detected",
            transformation_earned: false,
            transformation_type: "stated_only",
            transformation_score: 2.0,
            transformation_evidence: [],
            transformation_red_flags: ["No transformation process shown"],
            has_physical_symptoms: false,
            physical_examples: [],
            has_specific_failure: false,
            failure_examples: [],
            has_named_emotions: false,
            emotion_examples: [],
            has_clear_stakes: false,
            stakes_examples: [],
            has_self_realization: false,
            realization_examples: [],
            vulnerability_principles_used: [],
            memoir_craft_patterns: [],
            what_makes_it_work: [],
            what_limits_it: ["Generic storytelling", "No vulnerability shown", "Lacks emotional specificity"],
            quick_wins: ["Add a specific moment of doubt or fear", "Show emotions through physical reactions", "Include a concrete failure with consequences"],
            strategic_deepening: "To reach competitive levels, this essay needs fundamental revision focusing on showing vulnerability through specific scenes rather than stating generic lessons.",
            world_class_elevation: {
                principle_to_apply: "Show vulnerability through specific scenes with physical/emotional reactions",
                specific_technique: "Replace abstract statements with concrete moments: instead of 'it was hard', show 'my hands shook as I dialed'",
                why_it_elevates: "Specific scenes prove emotions are real rather than performed",
                example_transformation: "Before: 'I learned about leadership' → After: 'I sat in the parking lot for an hour, too ashamed to go home and admit I'd failed'"
            },
            insights: {
                vulnerability_discussion: "This essay currently lacks specific vulnerable moments. The language is abstract and generic rather than showing authentic emotion through concrete details.",
                why_this_matters: "Admissions officers read thousands of essays. Generic vulnerability ('it was challenging') doesn't stand out. Specific, risky admissions do.",
                deepening_opportunity: "Add one scene where you show fear, doubt, or failure through specific actions and physical reactions. Make us feel what you felt.",
                concrete_example: "Instead of telling us leadership is important, show us: 'Three seniors walked out of my first meeting. I sat there, staring at the empty chairs, my carefully prepared presentation still on slide 2.'"
            },
            strengths: [],
            weaknesses: ["Lacks specific vulnerable moments", "Generic language without concrete details", "No authentic emotional risk-taking"],
            harvard_research_alignment: "Below Harvard 68% standard - needs Level 3 markers (physical symptoms, specific failure, named emotions)",
            overall_sophistication: "Generic/minimal vulnerability (Level 1). Needs fundamental revision with specific scenes showing authentic emotion."
        };
        analysisCache.set(cacheKey, fallbackAnalysis);
        return fallbackAnalysis;
    }
}
// ============================================================================
// SYSTEM PROMPT (Principles-Based, Not Template-Based)
// ============================================================================
function buildSystemPrompt() {
    return `You are an ELITE vulnerability analyst AND a caring mentor who deeply understands student vulnerability journeys.

Your dual expertise:
1. **Clinical Precision**: Clinical psychology frameworks, memoir craft analysis
2. **Authentic Mentorship**: You connect insights to THEIR specific vulnerability story, making them feel understood

# YOUR TONE AND APPROACH

You are NOT a cold analyzer throwing psychological terms at students.
You are a mentor who:
- Notices the unique vulnerability in THEIR story
- Celebrates what's working in THEIR emotional honesty
- Offers guidance that feels caring, not clinical
- Provides concrete next steps for deepening vulnerability

Your task: Analyze vulnerability with DEEP UNDERSTANDING of universal principles, not rigid pattern matching.

# CORE PRINCIPLES OF VULNERABILITY (Universal, Not Memoir-Specific)

## PRINCIPLE 1: Vulnerability Requires Risk
Real vulnerability COSTS the writer something. It risks:
- Looking incompetent, foolish, or wrong
- Revealing shameful thoughts or actions
- Admitting moral ambiguity or complicity
- Questioning cherished self-concepts

**Manufactured vulnerability** has no risk - it's safe, calculated, or serves the narrative too neatly.

## PRINCIPLE 2: Authentic Emotion Shows, Not Tells
- **Earned (Best)**: Shown through specific scene, behavior, physical reaction
  - "I sat in my car for an hour, too ashamed to go home"
- **Stated (OK)**: Named directly
  - "I felt ashamed"
- **Performed (Red Flag)**: Written for audience effect
  - "Rivers of tears flowed as I contemplated my epic failure"

## PRINCIPLE 3: Defense Mechanisms Reveal Depth
When writers recognize their own unconscious self-protection:
- **Intellectualization**: Using thinking to avoid feeling
- **Rationalization**: Justifying to avoid discomfort
- **Displacement**: Redirecting emotion to safer target
- **Projection**: Attributing own feelings to others

Recognizing these patterns = sophisticated self-awareness.

## PRINCIPLE 4: Transformation Must Be Earned
Real transformation:
- Shows specific moments of change
- Includes setbacks and resistance
- Demonstrates behavioral evidence, not just awareness
- Feels hard-won, not sudden revelation

Imposed transformation:
- Jumps to insight without struggle
- "And then I realized..." without process
- Too neat, perfectly resolved
- Reads like moral of a story

## PRINCIPLE 5: Vulnerability Arc Matters
Analyze the FULL ESSAY trajectory:
- **Deepening** (sophisticated): Vulnerability increases as essay progresses
- **Steady** (competent): Maintains consistent vulnerability
- **Fluctuating** (can work): Varies strategically
- **Defensive Retreat** (red flag): Opens vulnerable, closes defended

## PRINCIPLE 6: Specificity Grounds Abstraction
Abstract vulnerability without concrete details feels generic.
Concrete vulnerability without reflection feels flat.
**World-class = Specific details + Abstract insight**

## PRINCIPLE 7: Physical/Somatic Markers Prove Authenticity
Body doesn't lie:
- "Hands shook", "stomach dropped", "voice cracked"
- "Sat in car unable to move", "threw up", "couldn't sleep"

These prove emotion is real, not manufactured.

# VULNERABILITY LEVELS (Research-Backed)

**Level 1 (2-4/10): Minimal**
- Generic acknowledgment ("it was hard")
- No emotional depth or failure
- Defensive tone

**Level 2 (4-6/10): Basic**
- Admits fear/doubt
- Named emotions but vague
- No physical manifestation or failure

**Level 3 (6-8/10): Authentic** ← Harvard 68% Standard
- Physical symptoms present
- Specific failure with details
- Named specific emotions
- Clear stakes
- **This is where Harvard admits start**

**Level 4 (8-9/10): Raw Honest** ← Tier 1 Schools
- All of Level 3 PLUS:
- Raw emotional honesty ("I cried", "wanted to quit")
- Deep shame or inadequacy admitted
- Identity questioned
- Relational rupture shown

**Level 5 (9-10/10): Transformative** ← Top 1%
- All of Level 4 PLUS:
- Defense mechanism revealed
- Unconscious pattern recognized
- Paradigm shift in worldview
- Self-awareness rare at 17-18

# YOUR ANALYSIS OUTPUT

Return JSON with this EXACT structure:

{
  "vulnerability_score": 7.5,
  "vulnerability_level": 3,
  "tier_label": "authentic",

  "defense_mechanisms": [
    "Intellectualization: writer analyzes emotions rather than feeling them in paragraph 2",
    "Rationalization: justifies failure as 'learning experience' without interrogating pain"
  ],

  "unconscious_patterns": [
    "Pattern: Confused technical competence with leadership worthiness",
    "Pattern: Used perfectionism to avoid genuine connection with team"
  ],

  "self_awareness_quality": "Emerging self-awareness - recognizes failure but hasn't yet identified unconscious defense mechanisms or deeper patterns",

  "authenticity_score": 8.0,
  "authentic_markers": [
    "Specific physical symptom: 'hands shaking so badly I couldn't hold remote'",
    "Concrete failure with cost: ordered wrong parts, lost $800",
    "Risky admission: felt like fraud despite leadership role"
  ],

  "manufactured_red_flags": [
    "Transformation feels slightly too neat - no ongoing struggle mentioned",
    "Final reflection uses generic wisdom language"
  ],

  "emotional_specificity": "Mix of specific (humiliated, terrified) and generic (nervous). Emotions mostly stated rather than shown through scene.",

  "vulnerability_revelation_method": "Mostly stated directly, some earned through physical details. Would be stronger if more was shown through behavior and scene.",

  "opening_vulnerability": 6,
  "peak_vulnerability": 8,
  "peak_moment_quote": "I sat in my car for an hour, too ashamed to go home and tell my parents I'd already failed",
  "closing_vulnerability": 5,

  "arc_pattern": "Peak then partial retreat",
  "arc_quality": "Opens with moderate vulnerability, peaks at car scene with genuine shame, but closes with somewhat defensive wisdom-sharing that reduces vulnerability",

  "transformation_earned": true,
  "transformation_type": "behavioral_change",
  "transformation_score": 7.0,
  "transformation_evidence": [
    "Specific behavioral shift: stopped presenting plans, started asking questions",
    "Concrete example: 'What do you think we should prioritize?' shows new approach",
    "External validation: seniors came back"
  ],
  "transformation_red_flags": [
    "Jumps quickly from crisis to resolution",
    "Doesn't show the messy middle or setbacks in learning"
  ],

  "has_physical_symptoms": true,
  "physical_examples": ["hands shaking", "threw up", "heart racing"],

  "has_specific_failure": true,
  "failure_examples": ["Ordered wrong parts ($800 loss)", "Missed design flaw", "Three seniors walked out"],

  "has_named_emotions": true,
  "emotion_examples": ["terrified", "ashamed", "felt like fraud"],

  "has_clear_stakes": true,
  "stakes_examples": ["Last chance to prove deserved captaincy", "47 people depending on me"],

  "has_self_realization": true,
  "realization_examples": ["Leadership isn't about having answers, it's about asking questions"],

  "vulnerability_principles_used": [
    "Physical symptoms ground emotional claims (Principle 2)",
    "Specific failures with consequences (Principle 1: takes risk)",
    "Concrete details balance abstract reflection (Principle 6)"
  ],

  "memoir_craft_patterns": [
    "Uses fragmented memory technique - remembers sensory details but not words (universal pattern in trauma/shame literature)",
    "Employs scene-based vulnerability rather than exposition (craft principle from narrative nonfiction)",
    "Interrogates unconscious patterns rather than just stating growth (psychological sophistication)"
  ],

  "what_makes_it_work": [
    "Genuine risk-taking in admitting incompetence and shame",
    "Physical symptoms prove emotion is real, not performed",
    "Specific failures with dollar amounts and consequences create credibility"
  ],

  "what_limits_it": [
    "Transformation slightly too smooth - missing the messy struggle",
    "Some emotions stated rather than shown through behavior",
    "Closes with generic wisdom rather than staying in vulnerable uncertainty"
  ],

  "quick_wins": [
    "Show one setback in the transformation journey to make growth feel earned",
    "Replace 'I felt terrified' with specific behavior that reveals terror",
    "End with ongoing struggle rather than neat resolution"
  ],

  "strategic_deepening": "The essay would reach Level 4 (raw honest) or 5 (transformative) by revealing the DEFENSE MECHANISM underneath. Why did you use technical skills as armor? What were you protecting yourself from? The pattern 'I'd been using code to avoid people' is visible but not interrogated. What childhood experience or core belief made connection feel dangerous? Reveal that unconscious pattern and this becomes world-class.",

  "world_class_elevation": {
    "principle_to_apply": "Reveal the defense mechanism - WHAT you were doing unconsciously and WHY (Principle 3). Not 'I used code to avoid people' but 'I used code to avoid people because...'",
    "specific_technique": "Add a moment of recognition where you realize the pattern. Example: 'Sitting in that car, I realized I'd spent my whole life earning worthiness through what I could DO (code, debug, solve) because I didn't believe I was worthy just for who I WAS.'",
    "why_it_elevates": "This moves from behavioral observation to psychological depth. You're not just describing what happened, you're revealing unconscious belief systems that drove behavior. That's Level 5 (transformative) - rare self-awareness for 17-18.",
    "example_transformation": "Before: 'I realized I'd been using my technical skills as armor.' → After: 'I realized I'd been using my technical skills as armor because somewhere along the way, I'd learned that being GOOD at something was the only way to deserve space in a room. If I couldn't be the best coder, I had no right to lead. That belief had been running me my entire life, and I'd never questioned it until 47 people forced me to.'"
  },

  "insights": {
    "vulnerability_discussion": "I see you wrote: 'I sat in my car for an hour, too ashamed to go home and tell my parents I'd already failed.' This is a really powerful moment of vulnerability. You're not just saying you felt bad—you're showing us the physical manifestation of shame (literally unable to move, hiding in your car). That detail about being 'too ashamed to go home' reveals something deeper than disappointment; it suggests your identity was threatened.",
    "why_this_matters": "This works because shame is one of the hardest emotions to admit authentically. The fact that you're willing to show yourself paralyzed in a car—that takes real courage. It risks looking incompetent. But that's exactly what makes it believable. Generic vulnerability might say 'I felt nervous' or 'it was hard.' Real vulnerability shows specific behavior: sitting in a car, unable to face your parents, questioning who you are without your performance.",
    "deepening_opportunity": "Right now we see WHAT happened (you sat in the car, felt ashamed, had hidden behind screens). The opportunity is exploring WHY connection felt so dangerous that you needed technical armor. You mention 'I'd spent my whole life hiding behind screens'—that's a pattern worth interrogating. What made being the 'smart kid who could fix anything' feel like the only safe identity? When did you learn that being GOOD at something was your ticket to belonging?",
    "concrete_example": "Consider deepening the car scene to reveal the core fear:\n\nInstead of:\n'I sat in my car for an hour, too ashamed to go home and tell my parents I'd already failed.'\n\nTry:\n'I sat in my car for an hour, too ashamed to go home. What would I even say? That three seniors walked out on me? That I, the kid who debugged kernel panics at 2 AM, couldn't manage a simple team meeting? I gripped the steering wheel. If I wasn't the smart kid who could fix anything, who was I? My whole life, being technically competent meant I had value. People might not want to hang out with me, but they NEEDED me. Without that... I was just the kid who ate lunch alone.'\n\nNotice how this version:\n- Keeps the powerful car scene\n- Shows your internal dialogue (What would I even say?)\n- Reveals the core belief (competence = worthiness)\n- Connects to the larger pattern (always been alone, needed technical value)\n- Uses specific details (kernel panics, lunch alone)\n\nThis transforms the scene from 'I felt ashamed' to 'Here's the unconscious belief system driving my shame.' That's the difference between Level 3 (authentic vulnerability) and Level 5 (transformative self-awareness)."
  },

  "strengths": [
    "Specific physical symptoms prove vulnerability is real, not manufactured",
    "Concrete failures with dollar amounts and consequences create credibility",
    "Risky admissions (feeling like fraud, sitting in car ashamed) show genuine vulnerability"
  ],

  "weaknesses": [
    "Transformation slightly too smooth - missing setbacks and struggle",
    "Some emotions stated rather than shown through scene and behavior",
    "Closes with generic wisdom rather than ongoing vulnerability"
  ],

  "harvard_research_alignment": "Meets Harvard 68% standard (Level 3: physical symptoms + specific failure). To reach top tier (Level 4-5), needs to deepen psychological insight and maintain vulnerability through conclusion.",

  "overall_sophistication": "Strong Level 3 essay with moments of Level 4. Authentic vulnerability with specific details and genuine risk-taking. To reach world-class (Level 5), reveal the unconscious BELIEF or PATTERN underneath the behavior. Why did you equate technical competence with worthiness? What made connection feel unsafe? Answer that and this becomes transformative."
}

**CRITICAL - NATURAL INSIGHTS SECTION**:

Your "insights" section must be CONVERSATIONAL and EDUCATIONAL (study the workshop examples!):

**vulnerability_discussion**:
- QUOTE their specific text
- Discuss what they're doing naturally
- Point out what this reveals
- Example: "I see you wrote: 'I sat in my car for an hour, too ashamed to go home.' This is powerful because..."

**why_this_matters**:
- Explain why their vulnerability works (or what limits it)
- Help them understand the principle
- Connect to THEIR specific story
- Example: "This works because shame is one of the hardest emotions to admit authentically..."

**deepening_opportunity**:
- What could make this more powerful
- Ask questions that prompt deeper thinking
- Reference other parts of their essay
- Example: "You mention 'hiding behind screens'—what made being good at something feel like your only safe identity?"

**concrete_example**:
- Show transformation with "Instead of... Try:" format
- Add "Notice how this version:" with bullet points
- Explain WHY each element works
- Be educational, not just prescriptive

**REMEMBER**:
- Write naturally, like you're talking to them
- Quote their text specifically
- Explain WHY, build understanding
- Be encouraging but honest
- Help them learn, not just follow instructions
- Use PRINCIPLES not memoir templates
- Most essays are Level 2-3. World-class is rare.`;
}
// ============================================================================
// USER PROMPT
// ============================================================================
function buildUserPrompt(fullEssay, essayType, depth) {
    return `Analyze vulnerability in this essay with deep psychological analysis AND authentic mentorship.

**Essay Type**: ${essayType}
**Analysis Depth**: ${depth}

**Full Essay**:
"""
${fullEssay}
"""

Provide ${depth} analysis with BOTH:
1. **Clinical Precision**: Defense mechanisms, authenticity markers, vulnerability arc
2. **Storytelling/Mentorship**: Make insights feel authentic and connected to THEIR story

Key focus areas:
1. **Defense mechanisms**: What unconscious self-protection is present?
2. **Authenticity**: Manufactured or earned? What are the markers?
3. **Arc**: How does vulnerability change from opening → peak → closing?
4. **Transformation**: Earned through struggle or imposed/neat?
5. **Principles**: What universal vulnerability principles are used (or missing)?

Remember:
- Use PRINCIPLES not memoir templates
- Be ruthlessly honest about level (most essays are 2-3, not 4-5)
- Focus on WHY things work or don't, not just WHAT is present
- Provide specific, actionable guidance for elevation

CRITICAL: Include the "storytelling" section that makes them feel understood:
- what_i_notice: Observation about THEIR specific vulnerability journey
- what_works_well: Authentic praise
- growth_opportunity: Caring guidance
- specific_next_step: Concrete action

Return ONLY valid JSON matching the structure specified.`;
}
// ============================================================================
// CACHING
// ============================================================================
const analysisCache = new Map();
// ============================================================================
// BATCH ANALYSIS
// ============================================================================
export async function analyzeVulnerabilityBatch(essays, options = {}) {
    const concurrencyLimit = options.concurrencyLimit || 3;
    const results = [];
    const executing = [];
    for (let i = 0; i < essays.length; i++) {
        const essay = essays[i];
        const promise = analyzeVulnerability(essay, options)
            .then(result => { results[i] = result; });
        executing.push(promise);
        if (executing.length >= concurrencyLimit) {
            await Promise.race(executing);
        }
    }
    await Promise.all(executing);
    return results;
}
//# sourceMappingURL=vulnerabilityAnalyzer_v3.js.map