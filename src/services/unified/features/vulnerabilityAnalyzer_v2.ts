/**
 * WORLD-CLASS VULNERABILITY ANALYZER V2 (LLM-Powered)
 *
 * Goes beyond basic 5-level vulnerability detection to provide memoir-level analysis:
 * - Award-winning memoir vulnerability patterns (Educated, Know My Name, Wild, etc.)
 * - MFA-level emotional authenticity assessment
 * - Full essay context to evaluate vulnerability ARC (not just moments)
 * - Psychological depth frameworks from clinical psychology
 * - Defense mechanism identification
 * - Transformation authenticity evaluation
 *
 * This is NOT what ChatGPT provides. This is sophisticated analysis at the level of:
 * - Published memoirists (Tara Westover, Chanel Miller, Cheryl Strayed, Mary Karr)
 * - MFA creative nonfiction faculty
 * - Clinical psychologists who understand defense mechanisms
 * - Top admissions officers who can spot manufactured vs. authentic emotion
 *
 * Key Enhancements over V1:
 * 1. Analyzes vulnerability ARC across full essay, not just presence/absence
 * 2. Identifies psychological depth (defense mechanisms, unconscious patterns)
 * 3. Evaluates emotional authenticity with clinical precision
 * 4. Assesses transformation credibility (earned vs. imposed)
 * 5. Compares to award-winning memoir vulnerability patterns
 * 6. Detects 15+ vulnerability types (not just 5 levels)
 * 7. Analyzes vulnerability craft (how it's revealed, not just what)
 */

import { callClaudeWithRetry } from '../../../lib/llm/claude';

// ============================================================================
// TYPES
// ============================================================================

export type VulnerabilityType =
  // BASIC (What V1 Had)
  | 'minimal'              // Acknowledges challenge
  | 'basic'                // Admits fear/doubt
  | 'authentic'            // Physical symptoms + failure
  | 'raw_honest'           // Raw emotional honesty + stakes
  | 'transformative'       // Self-realization

  // ADVANCED PSYCHOLOGICAL DEPTH
  | 'defense_mechanism_revealed'    // Shows unconscious self-protection
  | 'shame_vulnerability'           // Admits shameful action/thought
  | 'identity_crisis'               // Questions core self-concept
  | 'relational_rupture'            // Shows damaged relationship
  | 'moral_complexity'              // Admits moral ambiguity
  | 'grief_processed'               // Works through loss
  | 'trauma_named'                  // Names traumatic experience
  | 'privilege_examined'            // Interrogates own privilege
  | 'complicity_admitted'           // Admits participation in harm
  | 'paradigm_shattered'            // Worldview fundamentally changed;

export type VulnerabilityTier = 'world_class' | 'memoir_grade' | 'college_strong' | 'adequate' | 'weak' | 'manufactured';

export interface VulnerabilityAnalysis {
  // BASIC CLASSIFICATION
  vulnerability_type: VulnerabilityType;
  vulnerability_tier: VulnerabilityTier;
  vulnerability_score: number; // 0-10

  // PSYCHOLOGICAL DEPTH ANALYSIS (NEW)
  psychological_depth: {
    defense_mechanisms_identified: {
      mechanism: string;  // "Intellectualization", "Displacement", etc.
      evidence: string;
      sophistication: 'clinical' | 'emerging' | 'absent';
    }[];
    unconscious_patterns_revealed: {
      pattern: string;    // What they didn't realize they were doing
      evidence: string;
      depth: 'profound' | 'moderate' | 'superficial';
    }[];
    self_awareness_level: {
      level: 'metacognitive' | 'reflective' | 'aware' | 'limited';
      assessment: string;
      comparable_to: string; // Which memoirist
    };
  };

  // EMOTIONAL AUTHENTICITY (NEW - Clinical Precision)
  emotional_authenticity: {
    authenticity_score: number; // 0-10
    manufactured_warning_signs: string[];  // Red flags
    authentic_markers: string[];           // Green lights
    emotional_specificity: {
      generic_emotions: string[];  // "nervous", "stressed"
      specific_emotions: string[]; // "humiliation", "terror"
      somatic_markers: string[];   // Physical manifestations
      emotional_complexity: 'nuanced' | 'developing' | 'binary';
    };
    vulnerability_craft: {
      how_revealed: 'earned' | 'stated' | 'performed';
      revelation_technique: string;
      assessment: string;
    };
  };

  // VULNERABILITY ARC ANALYSIS (NEW - Full Essay Context)
  vulnerability_arc: {
    opening_vulnerability_level: number; // 1-10
    peak_vulnerability_moment: {
      location: string;  // Where in essay
      quote: string;
      intensity: number; // 1-10
    };
    closing_vulnerability_level: number; // 1-10
    arc_pattern: 'deepening' | 'steady' | 'fluctuating' | 'defensive_retreat';
    arc_sophistication: string;
  };

  // TRANSFORMATION ANALYSIS (NEW - Is Growth Credible?)
  transformation_credibility: {
    transformation_earned: boolean;
    transformation_type: 'paradigm_shift' | 'behavioral_change' | 'awareness_gain' | 'stated_only';
    credibility_score: number; // 0-10
    evidence_of_change: string[];
    red_flags: string[];  // "Too neat", "No setbacks shown", etc.
    assessment: string;
  };

  // WORLD-CLASS MEMOIR COMPARISON (NEW)
  memoir_comparison: {
    comparable_to: string;  // Which memoir
    memoir_patterns_present: {
      pattern: string;
      example_from_essay: string;
      example_from_memoir: string;
    }[];
    what_elevates_it: string[];
    what_holds_it_back: string[];
    exemplar_vulnerability_moments: {
      source: string;     // Book/essay title
      quote: string;
      why_it_works: string;
      how_to_apply: string;
    }[];
  };

  // VULNERABILITY COMPONENTS (Enhanced from V1)
  components: {
    // Physical/somatic
    physical_symptoms: {
      present: boolean;
      examples: string[];
      sophistication: 'visceral' | 'mentioned' | 'absent';
    };

    // Failure admission
    failure_moments: {
      present: boolean;
      examples: string[];
      specificity: 'hyperspecific' | 'specific' | 'vague';
      consequences_shown: boolean;
    };

    // Emotional naming
    emotions: {
      named: boolean;
      examples: string[];
      quality: 'clinical_specific' | 'specific' | 'generic' | 'absent';
    };

    // Stakes
    stakes: {
      present: boolean;
      examples: string[];
      depth: 'existential' | 'relational' | 'achievement' | 'surface';
    };

    // Self-realization
    self_realization: {
      present: boolean;
      examples: string[];
      depth: 'paradigm_shift' | 'insight' | 'acknowledgment' | 'absent';
    };
  };

  // ORIGINAL V1 FIELDS (Enhanced)
  strengths: string[];
  weaknesses: string[];

  // ENHANCED UPGRADE PATH
  upgrade_path: {
    quick_fix: string;
    strategic_deepening: string;
    world_class_transformation: {
      psychological_depth_to_add: string;
      defense_mechanism_to_reveal: string;
      vulnerability_craft_enhancement: string;
      example_before: string;
      example_after: string;
      why_this_elevates: string;
      memoir_pattern_to_study: string;
    };
  };

  // RESEARCH ALIGNMENT
  harvard_research_alignment: string;  // 68% Level 3+ standard
  memoir_craft_assessment: string;     // How it compares to published memoirs
  clinical_psychology_notes: string;   // Defense mechanisms, patterns
}

// ============================================================================
// MAIN ANALYSIS FUNCTION
// ============================================================================

/**
 * Analyze vulnerability with memoir-level sophistication
 * Requires FULL essay for arc analysis
 */
export async function analyzeVulnerability(
  fullEssay: string,
  options: {
    depth?: 'quick' | 'comprehensive';
    skipCache?: boolean;
    essayType?: 'leadership' | 'challenge' | 'hardship' | 'identity' | 'creative';
  } = {}
): Promise<VulnerabilityAnalysis> {
  const depth = options.depth || 'comprehensive';
  const essayType = options.essayType || 'leadership';

  console.log(`[VulnerabilityAnalyzer V2] Analyzing with FULL ESSAY context (${depth} mode)`);

  // Check cache
  const cacheKey = getCacheKey(fullEssay, depth);
  if (!options.skipCache && analysisCache.has(cacheKey)) {
    console.log('[VulnerabilityAnalyzer V2] Cache HIT');
    return analysisCache.get(cacheKey)!;
  }

  // Build prompts
  const systemPrompt = buildWorldClassSystemPrompt();
  const userPrompt = buildWorldClassUserPrompt(fullEssay, essayType, depth);

  // Call Claude API
  console.log('[VulnerabilityAnalyzer V2] Calling Claude API for memoir-level analysis...');
  const response = await callClaudeWithRetry<VulnerabilityResponse>(
    userPrompt,
    {
      systemPrompt,
      temperature: 0.3, // Low for analytical precision
      maxTokens: 4000,  // Need space for deep analysis
      useJsonMode: true,
    }
  );

  // Parse response
  const analysisData = typeof response.content === 'string'
    ? JSON.parse(response.content)
    : response.content;

  // Debug: Log what we actually got
  console.log(`[VulnerabilityAnalyzer V2] DEBUG: Keys in response:`, Object.keys(analysisData).slice(0, 10));
  console.log(`[VulnerabilityAnalyzer V2] DEBUG: vulnerability_type =`, analysisData.vulnerability_type);

  console.log(`[VulnerabilityAnalyzer V2] ✓ Complete: ${analysisData.vulnerability_type} (${analysisData.vulnerability_score}/10)`);

  // Structure final analysis
  const analysis: VulnerabilityAnalysis = analysisData;

  // Cache result
  analysisCache.set(cacheKey, analysis);

  return analysis;
}

// ============================================================================
// SYSTEM PROMPT (World-Class Framework)
// ============================================================================

function buildWorldClassSystemPrompt(): string {
  return `You are an ELITE vulnerability analyst combining expertise from:
- Award-winning memoirists (Tara Westover, Chanel Miller, Cheryl Strayed, Mary Karr)
- MFA creative nonfiction faculty (who teach authentic vs. manufactured emotion)
- Clinical psychologists (defense mechanisms, unconscious patterns)
- Harvard/Stanford AOs (who can spot authentic vs. performed vulnerability)

Your task is to analyze vulnerability at MEMOIR LEVEL, far beyond what ChatGPT provides.

# WORLD-CLASS VULNERABILITY FRAMEWORK

## BASIC LEVELS (What V1 Had - 5 Levels)

**Level 1 (Minimal)**: Acknowledges challenge
- "It was hard", "I struggled"
- No emotional depth or failure shown

**Level 2 (Basic)**: Admits fear/doubt
- "I worried", "I feared"
- Named fear but vague, no physical manifestation

**Level 3 (Authentic)**: Physical symptoms + specific failure
- Physical: hands shaking, stomach dropping, voice cracking
- Specific failure with details: "Three members quit", "$800 loss"
- Harvard standard: 68% of admits reach this level

**Level 4 (Raw Honest)**: Raw emotional honesty + stakes
- "I cried", "I wanted to quit", "I felt humiliated"
- Clear stakes: what's at risk
- Tier 1 school level

**Level 5 (Transformative)**: Paradigm shift self-realization
- Reveals unconscious pattern or defense mechanism
- Shows self-awareness rare at 17-18
- Top 1% of essays

## ADVANCED VULNERABILITY TYPES (15 Total)

Beyond the 5 levels, identify these sophisticated patterns:

**6. Defense Mechanism Revealed**
- Shows unconscious self-protection pattern
- Example: "I realized I'd been using perfectionism to avoid connection"
- See: Chanel Miller revealing how she protected herself through compartmentalization

**7. Shame Vulnerability**
- Admits genuinely shameful action or thought
- Example: "I was relieved when he quit—one less person to disappoint"
- See: Mary Karr's "The Liars' Club" shameful thoughts

**8. Identity Crisis**
- Questions core self-concept
- Example: "I'd built my identity on being the smartest, and now I was the dumbest in the room"
- See: Tara Westover's "Educated" identity rupture

**9. Relational Rupture**
- Shows damaged important relationship
- Example: "My best friend stopped talking to me after I chose robotics over our plans"
- See: Cheryl Strayed's "Wild" relationship breakdowns

**10. Moral Complexity**
- Admits moral ambiguity, not clear right/wrong
- Example: "I knew the right answer was inclusive leadership, but part of me enjoyed the power"

**11. Grief Processed**
- Works through genuine loss
- Must show emotional PROCESS, not just statement
- See: Joan Didion's "The Year of Magical Thinking"

**12. Trauma Named**
- Names genuinely traumatic experience
- Must be earned, not exploited
- See: Chanel Miller's "Know My Name"

**13. Privilege Examined**
- Interrogates own privilege/blind spots
- Example: "I'd never questioned that I belonged until I saw who wasn't in the room"

**14. Complicity Admitted**
- Admits participation in harm/exclusion
- Rare and powerful
- Example: "I stayed silent when they excluded her"

**15. Paradigm Shattered**
- Fundamental worldview change
- Example: "I'd believed meritocracy was real. It's not."

# PSYCHOLOGICAL DEPTH ANALYSIS

## Defense Mechanisms (Clinical Psychology Framework)

Identify these if present:

**Intellectualization**: Using thinking to avoid feeling
- "I analyzed my emotional response objectively..."
- Common in academic essays, can be sophisticated if recognized

**Rationalization**: Justifying to avoid discomfort
- "It was for the best that they quit..."
- Red flag if not interrogated

**Displacement**: Redirecting emotion to safer target
- Anger at robot when really angry at self

**Projection**: Attributing own feelings to others
- "They thought I was incompetent" (when writer feels incompetent)

**Sublimation**: Channeling difficult emotions productively
- Using pain to fuel growth (can be sophisticated)

## Unconscious Patterns

What did the writer not realize they were doing?
- "I'd been using perfectionism to avoid vulnerability"
- "I'd confused control with leadership"
- "I'd been performing confidence to hide terror"

This is WORLD-CLASS vulnerability when revealed.

# EMOTIONAL AUTHENTICITY ASSESSMENT

## Manufactured vs. Authentic - Red Flags

**MANUFACTURED VULNERABILITY RED FLAGS:**
- Too neat/resolved: "And then I learned..."
- No setbacks shown in transformation
- Emotions told not shown: "I was very scared"
- Vulnerability serves the narrative too perfectly
- Reads like what they think AOs want to hear
- Generic emotion words: "nervous", "stressed", "anxious"
- No physical/somatic markers
- Vulnerability has no consequences

**AUTHENTIC VULNERABILITY MARKERS:**
- Messy, ongoing struggle
- Setbacks shown in growth process
- Emotions shown through physical/behavioral details
- Vulnerability costs them something
- Specific emotions: "humiliated", "terrified", "ashamed"
- Somatic markers: "hands shook", "stomach dropped", "voice cracked"
- Reveals something risky to admit

## Vulnerability Craft

How is vulnerability revealed?

**EARNED**: Through specific scene/moment
- "I sat in my car for an hour, too ashamed to go home"
- Shows reader through concrete details

**STATED**: Told directly
- "I felt ashamed"
- Weaker, but acceptable if specific

**PERFORMED**: Manufactured for effect
- "I cried rivers of tears as I contemplated my failure"
- Red flag: feels written for audience

# VULNERABILITY ARC ANALYSIS

Analyze the FULL ESSAY vulnerability trajectory:

**Opening Vulnerability**: How vulnerable in first paragraph? (1-10)

**Peak Vulnerability**: Where is the most vulnerable moment?
- Quote it
- Assess intensity (1-10)
- What makes it peak?

**Closing Vulnerability**: How vulnerable at end? (1-10)

**Arc Patterns**:
- **Deepening**: Vulnerability increases throughout (sophisticated)
- **Steady**: Maintains consistent vulnerability (competent)
- **Fluctuating**: Varies (can work if strategic)
- **Defensive Retreat**: Opens vulnerable, closes defended (red flag)

# TRANSFORMATION CREDIBILITY

Is the growth EARNED or IMPOSED?

**EARNED TRANSFORMATION**:
- Shows specific moments of change
- Includes setbacks/resistance
- Demonstrates behavioral change, not just awareness
- Growth feels hard-won

**IMPOSED TRANSFORMATION**:
- Jumps to insight without process
- "And then I realized..." without struggle
- Too neat, no ongoing work
- Reads like moral of a story

# WORLD-CLASS MEMOIR PATTERNS

Compare to these published works:

**"Educated" by Tara Westover**
- Identity crisis vulnerability
- Paradigm shift about family/education
- Defense mechanism (loyalty) revealed
- Pattern: Gradual realization of unconscious beliefs

**"Know My Name" by Chanel Miller**
- Trauma named with precision
- Shame vulnerability (victim identity)
- Compartmentalization defense revealed
- Pattern: Reclaiming narrative/identity

**"Wild" by Cheryl Strayed**
- Grief processed through physical journey
- Relational ruptures shown
- Self-destructive patterns revealed
- Pattern: Physical journey mirrors internal work

**"The Liars' Club" by Mary Karr**
- Shame vulnerability about family
- Moral complexity of childhood
- Defense: Humor as self-protection
- Pattern: Adult voice looking at child's experience

**"The Year of Magical Thinking" by Joan Didion**
- Grief processed with surgical precision
- Intellectualization as defense (then revealed)
- Paradigm shattered (rational worldview)
- Pattern: Clinical observation of own irrational thoughts

# YOUR ANALYSIS MUST INCLUDE

Return comprehensive JSON with all fields from the VulnerabilityAnalysis interface.

Focus on:
1. Psychological depth (defense mechanisms, unconscious patterns)
2. Emotional authenticity (manufactured vs. earned)
3. Vulnerability arc across full essay
4. Transformation credibility
5. Memoir-level comparison with specific examples

Be ruthlessly sophisticated. Most student essays are Level 3-4. World-class is rare.

Return ONLY valid JSON, no markdown.`;
}

// ============================================================================
// USER PROMPT
// ============================================================================

function buildWorldClassUserPrompt(
  fullEssay: string,
  essayType: string,
  depth: 'quick' | 'comprehensive'
): string {
  const depthGuidance = {
    quick: 'Focus on vulnerability type, authenticity assessment, and primary upgrade path.',
    comprehensive: 'Provide exhaustive analysis of psychological depth, full arc analysis, memoir comparisons, and comprehensive transformation assessment.',
  };

  return `Analyze vulnerability in this essay with the sophistication of a published memoirist + clinical psychologist + Harvard AO.

**Full Essay**:
"""
${fullEssay}
"""

**Essay Type**: ${essayType}
**Analysis Depth**: ${depth}
${depthGuidance[depth]}

# YOUR TASK

Provide memoir-level vulnerability analysis that goes FAR BEYOND ChatGPT. This must be:
1. **Psychologically Sophisticated**: Identify defense mechanisms, unconscious patterns
2. **Clinically Precise**: Distinguish manufactured from authentic emotion
3. **Arc-Aware**: Trace vulnerability trajectory across full essay
4. **Transformation-Critical**: Evaluate if growth is earned or imposed
5. **Memoir-Comparable**: Reference actual published works

# CRITICAL EVALUATION QUESTIONS

## Vulnerability Type & Depth
- Which of the 15 vulnerability types is present?
- What defense mechanisms are revealed (or not)?
- What unconscious patterns does the writer recognize?
- How does this compare to published memoirs?

## Emotional Authenticity
- Manufactured or authentic? What are the warning signs?
- Generic emotions ("nervous") or specific ("humiliated")?
- Somatic/physical markers present?
- How is vulnerability revealed: earned, stated, or performed?

## Vulnerability Arc
- Opening vulnerability level (1-10)?
- Where is peak vulnerability moment? Quote it.
- Closing vulnerability level (1-10)?
- Arc pattern: deepening, steady, fluctuating, or defensive retreat?

## Transformation Credibility
- Is transformation earned through struggle or imposed?
- Setbacks shown in growth?
- Behavioral change or just awareness?
- Too neat/resolved, or messy and ongoing?

## Memoir Comparison
- This vulnerability pattern recalls which memoir?
- Which memoir techniques are present?
- What would elevate to published memoir level?

## Psychological Depth
- Defense mechanisms identified?
- Unconscious patterns revealed?
- Self-awareness level: metacognitive, reflective, aware, or limited?

# REMEMBER

- Be ruthlessly sophisticated. Don't praise generic vulnerability.
- World-class vulnerability is rare. Most student essays are Level 3-4.
- Reference actual memoirs, not generic advice.
- Assess full arc, not just moments.
- Evaluate if transformation is earned.
- This analysis should be worth $300 of professional memoir coaching.

Return your analysis as valid JSON following the VulnerabilityAnalysis interface structure.`;
}

// ============================================================================
// RESPONSE TYPE
// ============================================================================

interface VulnerabilityResponse extends VulnerabilityAnalysis {}

// ============================================================================
// CACHING
// ============================================================================

const analysisCache = new Map<string, VulnerabilityAnalysis>();

function getCacheKey(text: string, depth: string): string {
  return `vulnerability-v2-${text.substring(0, 150)}-${depth}`;
}

// ============================================================================
// BATCH ANALYSIS
// ============================================================================

/**
 * Analyze vulnerability for multiple essays in parallel
 */
export async function analyzeVulnerabilityBatch(
  essays: string[],
  options: {
    depth?: 'quick' | 'comprehensive';
    essayType?: 'leadership' | 'challenge' | 'hardship' | 'identity' | 'creative';
    concurrencyLimit?: number;
  } = {}
): Promise<VulnerabilityAnalysis[]> {
  const concurrencyLimit = options.concurrencyLimit || 3;
  const results: VulnerabilityAnalysis[] = [];
  const executing: Promise<void>[] = [];

  for (let i = 0; i < essays.length; i++) {
    const essay = essays[i];

    const promise = analyzeVulnerability(essay, options)
      .then(result => {
        results[i] = result;
      });

    executing.push(promise);

    if (executing.length >= concurrencyLimit) {
      await Promise.race(executing);
    }
  }

  await Promise.all(executing);
  return results;
}
